# $Id$

#=begin overview

#This is the grammar for fun written as a sequence of Perl 6 rules.

#=end overview

grammar fun::Grammar is PCT::Grammar;

rule TOP {
	[<func>|<expr>]*
	[ $ || <panic: 'Syntax error'> ]
	{*}
}

##  this <ws> rule treats # as "comment to eol"
##  you may want to replace it with something appropriate
token ws {
    <!ww>
    [ '#' \N* \n? | \s+ ]*
}

##'ident' sucks I want hyphens dammit.
token funcname { 
	[ \w | '-' | '?' | '=' <!before '='> ]+ {*}
}

token print {
	'.'	{*}
}

##These arent really expressions but whatever.
rule expr {
##Fundamental stuff
	| <list>	{*} #= list
	| <value>	{*} #= value
	| <print>	{*} #= print

##Built in functions
	| <builtins> {*} #= builtins
	
##Possibly a user function call (this is the 'last resort' match)
	|| <userfunccall>	{*} #= userfunccall
}

##The function is trechnically a list, but "<ident> == <list>" adds an extra (unnecessary) layer,
##because I have to dig <expr> out of the <list>
rule func {
	| '[' <expr>* ']' <funcname> '==' {*}
	| <funcname> '[' <expr>* ']' '==' {*}
}

rule list { 
	'[' <expr>* ']' {*} 
}

token value {
	| <float> 	{*} #= float
	| <integer>	{*} #= integer
	| <string> 	{*} #= string
	| <bool> 	{*} #= bool
	| <char> 	{*} #= char
}

token integer { '-'? \d+ {*} }
token float { '-'? \d* '.' \d+ {*} }
token bool { ['true' | 'false'] {*} }
token char { \' $<chr>=. <!before \'> {*} }
token string {
    [ \' <string_literal: '\'' > \' | \" <string_literal: '"' > \" ]
    {*}
}

token builtins {
	[
	| 'ban-space-kimchi' {*}
	| 'localtime' {*}
	| 'rolldownd' {*}
	| 'strftime' {*}
	| 'rolldown' {*}
	| 'putchars' {*}
	| 'enconcat' {*}
	| 'include' {*}
	| 'unstack' {*}
	| 'tailrec' {*}
	| 'nullary' {*}
	| 'ternary' {*}
	| 'rollupd' {*}
	| 'rotated' {*}
	| 'unswons' {*}
	| 'reverse' {*}
	| 'gmtime' {*}
	| 'mktime' {*}
	| 'strtol' {*}
	| 'intern' {*}
	| 'linrec' {*}
	| 'binrec' {*}
	| 'genrec' {*}
	| 'binary' {*}
	| 'cleave' {*}
	| 'rollup' {*}
	| 'rotate' {*}
	| 'choice' {*}
	| 'branch' {*}
	| 'opcase' {*}
	| 'ifbool' {*}
	| 'iflist' {*}
	| 'iffile' {*}
	| 'uncons' {*}
	| 'filter' {*}
	| 'concat' {*}
	| 'toint' {*}
	| 'tonum' {*}
	| 'tostr' {*}
	| 'stack' {*}
	| 'times' {*}
	| 'unary' {*}
	| 'while' {*}
	| 'swapd' {*}
	| 'print' {*}
	| 'ifint' {*}
	| 'ifstr' {*}
	| 'ifnum' {*}
	| 'swons' {*}
	| 'first' {*}
	| 'split' {*}
	| 'srand' {*}
	| 'atan2' {*}
	| 'floor' {*}
	| 'frexp' {*}
	| 'ldexp' {*}
	| 'log10' {*}
	| 'trunc' {*}
	| 'small' {*}
	| 'equal' {*}
	| 'bool?' {*}
	| 'char?' {*}
	| 'list?' {*}
	| 'file?' {*}
	| 'time' {*}
	| 'name' {*}
	| 'body' {*}
	| 'dupd' {*}
	| 'swap' {*}
	| 'popd' {*}
	| 'sign' {*}
	| 'ifte' {*}
	| 'cond' {*}
	| 'case' {*}
	| 'cons' {*}
	| 'rest' {*}
	| 'step' {*}
	| 'fold' {*}
	| 'rand' {*}
	| 'acos' {*}
	| 'asin' {*}
	| 'atan' {*}
	| 'ceil' {*}
	| 'cosh' {*}
	| 'modf' {*}
	| 'sinh' {*}
	| 'sqrt' {*}
	| 'tanh' {*}
	| 'null' {*}
	| 'num?' {*}
	| 'int?' {*}
	| 'str?' {*}
	| 'dip' {*}
	| 'dup' {*}
	| 'pop' {*}
	| 'mod' {*}
	| 'rem' {*}
	| 'div' {*}
	| 'abs' {*}
	| 'neg' {*}
	| 'put' {*}
	| 'map' {*}
	| 'ord' {*}
	| 'chr' {*}
	| 'cos' {*}
	| 'exp' {*}
	| 'log' {*}
	| 'pow' {*}
	| 'sin' {*}
	| 'tan' {*}
	| 'and' {*}
	| 'xor' {*}
	| 'not' {*}
	| 'cmp' {*}
	| '++' {*}
	| '--' {*}
	| 'at' {*}
	| 'of' {*}
	| '!=' {*}
	| '<=' {*}
	| '>=' {*}
	| 'or' {*}
	| 'i' {*}
	| 'x' {*}
	| '+' {*}
	| '-' {*}
	| '*' {*}
	| '/' {*}
	| '<' {*}
	| '>' {*}
	| '=' {*}

	] <?before [ \s | '[' | ']' | '.' ]>
}

token userfunccall {
	<funcname> {*}
}